# Metrics Common

`metrics-common` — библиотека для интеграции распределенной трассировки с использованием **Jaeger** 
в микро-сервисной архитектуре. Она позволяет автоматически отслеживать межсервисные взаимодействия 
на уровне **REST/HTTP** и упрощает подключение инструментов мониторинга в приложения на основе **Spring Boot**.

---

## Основные возможности

- **Извлечение контекста трассировки:** Поддержка заголовка `uber-trace-id` для восстановления цепочки вызовов.
- **Интеграция с REST-запросами:** Автоматическое добавление трассировочных данных в исходящие HTTP-запросы.
- **Поддержка AOP (Aspect Oriented Programming):** Автоматическое создание Spans для бизнес-логики 
- и внутренних операций.
- **Гибкая настройка:** Возможность задавать параметры семплирования и другие настройки через `application.yml`.
- **Совместимость с OpenTracing API:** Поддерживает стандартный интерфейс трассировки.

---

## Как подключить

### 1. Добавьте зависимость в **build.gradle** вашего проекта:

```groovy
dependencies {
    implementation "ru.gpb.ccl:open-tracing-common:1.0.0-b14-bbfb1de"
}
```

---

### 2. Настройте Jaeger в **application.yml**:

```yaml
# Настройка трассировки Jaeger
opentracing:
  jaeger:
    udp-sender:
      host: {{ jaeger.jaeger_agent_address }} # Адрес Jaeger Agent
      port: 6831 # Порт Jaeger Agent
    service-name: {{ app_name }} # Название сервиса
    sampler-type: {{ jaeger.jaeger_sampler_type }} # Тип семплирования
    sampler-param: {{ jaeger.jaeger_sampler_param }} # Параметр семплирования

feature-flag:
  ccc-jaeger:
    tracing:
      enabled: false # Включение/выключение трассировки
```

Пример для локального запуска на EBG_DEMO:

```yaml
# Настройка трассировки Jaeger для локальной среды
opentracing:
  jaeger:
    udp-sender:
      host: 10.178.49.171
      port: 6831
    service-name: integration-data-service
    sampler-type: const
    sampler-param: 1

feature-flag.ccc-jaeger.tracing.enabled: false
```

---

### 3. Включение флага трассировки

Перед использованием Jaeger необходимо включить флаг `feature-flag.ccc-jaeger.tracing.enabled`. 
Это можно сделать с помощью REST API флагов:

- **Включение флага:**

```http
PUT http://<flag-service-host>/api/v1/flags/activate
{
  "name": "feature-flag.ccc-jaeger.tracing.enabled"
}
```

- **Проверка состояния флага:**

```http
GET http://<flag-service-host>/api/v1/flags
```

---

## Принцип работы

1. **Извлечение контекста трассировки:**
   Библиотека анализирует входящие HTTP-запросы и извлекает заголовок `uber-trace-id`, 
2. если он присутствует. Если заголовок отсутствует, создается новый `trace-id` для начала новой трассы.

2. **Передача контекста:**
   Исходящие HTTP-запросы автоматически дополняются заголовком `uber-trace-id`, чтобы сохранить связь между запросами.

3. **Создание Spans:**
   С помощью AOP автоматически создаются Spans для выполнения бизнес-логики и вызовов между сервисами.

4. **Отправка данных:**
   Данные о трассировке отправляются в Jaeger Agent, откуда попадают в Jaeger UI для визуализации.

---

## Основные компоненты

### **1. JaegerHttpTracingExtractor**
Класс, который отвечает за извлечение контекста трассировки из входящих HTTP-запросов. 
Использует стандарт OpenTracing для обработки заголовков.

### **2. JaegerHTTPTracingRestTemplateInterceptor**
Интерцептор для RestTemplate, добавляющий заголовок `uber-trace-id` в каждый исходящий HTTP-запрос.

### **3. AOP для бизнес-логики**
С помощью аспектов библиотека автоматически добавляет Spans для методов, 
помеченных аннотациями `@Service` и `@RestController`.

---

## Примеры использования

### 1. Проверка трассировки в Jaeger
- После включения трассировки выполните несколько операций в вашем сервисе.
- Перейдите в интерфейс Jaeger (например, `http://<jaeger-host>:16686`).
- Найдите ваш `service-name` и убедитесь, что запросы отображаются в виде цепочки Spans.

### 2. Анализ производительности
- Используйте временную шкалу Jaeger для анализа времени выполнения каждого Spana.
- Проверьте узкие места и долгие операции.

---

## Примечания

1. **Семплирование:**
    - Для среды PROM рекомендуется использовать `sampler-type: probabilistic` с `sampler-param: 0.1`, 
    - чтобы записывать только 10% запросов.
    - Для тестовых сред используйте `sampler-type: const` с `sampler-param: 1` для трассировки всех запросов.

2. **Локальная разработка:**
    - Включайте трассировку только при необходимости.
    - Убедитесь, что флаг `feature-flag.ccc-jaeger.tracing.enabled` установлен в `false`, 
    - чтобы избежать ошибок при сборке.

---

## Лицензия

Эта библиотека разработана и поддерживается в рамках open-source.
